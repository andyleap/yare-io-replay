<html>
    <head>
        <style>
            html, body {
                margin: 0;
            }
        </style>
        <script>var LZString=function(){function o(o,r){if(!t[o]){t[o]={};for(var n=0;n<o.length;n++)t[o][o.charAt(n)]=n}return t[o][r]}var r=String.fromCharCode,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",t={},i={compressToBase64:function(o){if(null==o)return"";var r=i._compress(o,6,function(o){return n.charAt(o)});switch(r.length%4){default:case 0:return r;case 1:return r+"===";case 2:return r+"==";case 3:return r+"="}},decompressFromBase64:function(r){return null==r?"":""==r?null:i._decompress(r.length,32,function(e){return o(n,r.charAt(e))})},compressToUTF16:function(o){return null==o?"":i._compress(o,15,function(o){return r(o+32)})+" "},decompressFromUTF16:function(o){return null==o?"":""==o?null:i._decompress(o.length,16384,function(r){return o.charCodeAt(r)-32})},compressToUint8Array:function(o){for(var r=i.compress(o),n=new Uint8Array(2*r.length),e=0,t=r.length;t>e;e++){var s=r.charCodeAt(e);n[2*e]=s>>>8,n[2*e+1]=s%256}return n},decompressFromUint8Array:function(o){if(null===o||void 0===o)return i.decompress(o);for(var n=new Array(o.length/2),e=0,t=n.length;t>e;e++)n[e]=256*o[2*e]+o[2*e+1];var s=[];return n.forEach(function(o){s.push(r(o))}),i.decompress(s.join(""))},compressToEncodedURIComponent:function(o){return null==o?"":i._compress(o,6,function(o){return e.charAt(o)})},decompressFromEncodedURIComponent:function(r){return null==r?"":""==r?null:(r=r.replace(/ /g,"+"),i._decompress(r.length,32,function(n){return o(e,r.charAt(n))}))},compress:function(o){return i._compress(o,16,function(o){return r(o)})},_compress:function(o,r,n){if(null==o)return"";var e,t,i,s={},p={},u="",c="",a="",l=2,f=3,h=2,d=[],m=0,v=0;for(i=0;i<o.length;i+=1)if(u=o.charAt(i),Object.prototype.hasOwnProperty.call(s,u)||(s[u]=f++,p[u]=!0),c=a+u,Object.prototype.hasOwnProperty.call(s,c))a=c;else{if(Object.prototype.hasOwnProperty.call(p,a)){if(a.charCodeAt(0)<256){for(e=0;h>e;e++)m<<=1,v==r-1?(v=0,d.push(n(m)),m=0):v++;for(t=a.charCodeAt(0),e=0;8>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}else{for(t=1,e=0;h>e;e++)m=m<<1|t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t=0;for(t=a.charCodeAt(0),e=0;16>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}l--,0==l&&(l=Math.pow(2,h),h++),delete p[a]}else for(t=s[a],e=0;h>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1;l--,0==l&&(l=Math.pow(2,h),h++),s[c]=f++,a=String(u)}if(""!==a){if(Object.prototype.hasOwnProperty.call(p,a)){if(a.charCodeAt(0)<256){for(e=0;h>e;e++)m<<=1,v==r-1?(v=0,d.push(n(m)),m=0):v++;for(t=a.charCodeAt(0),e=0;8>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}else{for(t=1,e=0;h>e;e++)m=m<<1|t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t=0;for(t=a.charCodeAt(0),e=0;16>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}l--,0==l&&(l=Math.pow(2,h),h++),delete p[a]}else for(t=s[a],e=0;h>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1;l--,0==l&&(l=Math.pow(2,h),h++)}for(t=2,e=0;h>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1;for(;;){if(m<<=1,v==r-1){d.push(n(m));break}v++}return d.join("")},decompress:function(o){return null==o?"":""==o?null:i._decompress(o.length,32768,function(r){return o.charCodeAt(r)})},_decompress:function(o,n,e){var t,i,s,p,u,c,a,l,f=[],h=4,d=4,m=3,v="",w=[],A={val:e(0),position:n,index:1};for(i=0;3>i;i+=1)f[i]=i;for(p=0,c=Math.pow(2,2),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;switch(t=p){case 0:for(p=0,c=Math.pow(2,8),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;l=r(p);break;case 1:for(p=0,c=Math.pow(2,16),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;l=r(p);break;case 2:return""}for(f[3]=l,s=l,w.push(l);;){if(A.index>o)return"";for(p=0,c=Math.pow(2,m),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;switch(l=p){case 0:for(p=0,c=Math.pow(2,8),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;f[d++]=r(p),l=d-1,h--;break;case 1:for(p=0,c=Math.pow(2,16),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;f[d++]=r(p),l=d-1,h--;break;case 2:return w.join("")}if(0==h&&(h=Math.pow(2,m),m++),f[l])v=f[l];else{if(l!==d)return null;v=s+s.charAt(0)}w.push(v),f[d++]=s+v.charAt(0),h--,s=v,0==h&&(h=Math.pow(2,m),m++)}}};return i}();"function"==typeof define&&define.amd?define(function(){return LZString}):"undefined"!=typeof module&&null!=module&&(module.exports=LZString);</script>
    </head>
    <body>
        <canvas id="game" style="display: none;"></canvas>

        <div id="drop_zone" style="width: 100%; height: 100%; text-align: center;">Drop replay json here</div>
        
        <script>
            var scale = 4.75;
            var center = [2100, 1200];

            function getScale() {
                return (1/16) * 2**scale;
            }

            function getPos(p, size) {
                return p/getScale() + size/2;
            }

            var gameEle = document.getElementById("game");

            gameEle.addEventListener('wheel', function(e) {
                e.preventDefault();
                scale += e.deltaY * 0.001;
                scale = Math.min(Math.max(scale, 1), 20);
            });

            var lastMouse = [0, 0];
            var mouseDown = false;

            gameEle.addEventListener('mousedown', function(e) {
                mouseDown = true;
                lastMouse = [e.x, e.y];
            });

            gameEle.addEventListener('mouseup', function(e) {
                mouseDown = false;
            });

            gameEle.addEventListener('mousemove', function(e) {
                if(mouseDown) {
                    center[0] += (lastMouse[0] - e.x) * getScale();
                    center[1] += (lastMouse[1] - e.y) * getScale();
                    lastMouse = [e.x, e.y];
                }
            });

            var dataPos = 0;

            window.addEventListener('keydown', e => {
                e.preventDefault();
                switch(event.code) {
                    case "KeyA":
                    case "ArrowLeft":
                    // Handle "turn right"
                    dataPos--;
                    if(dataPos < 0) {
                        dataPos = 0;
                    }
                    break;
                    case "KeyD":
                    case "ArrowRight":
                    // Handle "turn left"
                    dataPos++;
                    if(dataPos >= Object.keys(data).length-1) {
                        dataPos = Object.keys(data).length-1
                    }
                    break;
                }
            }, true);

            var data = {};
            var sides = {}
                

            var base_things = {
                star_a1c: [ 3200, 1400 ],
                star_zxq : [ 1000, 1000 ],
            };
            
            function handleFileSelect(evt) {
                evt.stopPropagation();
                evt.preventDefault();
                
                var files = evt.dataTransfer.files; // FileList object.
                
                files[0].text().then(text => {
                    data = JSON.parse(LZString.decompressFromUTF16(text));
                    sides = {
                        s1: Object.keys(data[0].p1)[0].split("_")[0],
                        s2: Object.keys(data[0].p2)[0].split("_")[0],
                    };
                    base_things["base_" + sides.s1] = [1600, 700];
                    base_things["base_" + sides.s2] = [2600, 1700];
                    window.requestAnimationFrame(draw);
                    gameEle.style.display = "block";
                    document.getElementById("drop_zone").style.display = "none";
                });
            }
        
            function handleDragOver(evt) {
                evt.stopPropagation();
                evt.preventDefault();
                evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
            }
        
            // Setup the dnd listeners.
            var dropZone = document.getElementById('drop_zone');
            dropZone.addEventListener('dragover', handleDragOver, false);
            dropZone.addEventListener('drop', handleFileSelect, false);


        
            function draw() {
                window.requestAnimationFrame(draw);

                var ctx = gameEle.getContext('2d');
                ctx.canvas.width  = window.innerWidth;
                ctx.canvas.height = window.innerHeight;

                ctx.fillStyle = "black";
                ctx.fillRect(0, 0, gameEle.width, gameEle.height);
                var w = gameEle.width;
                var h = gameEle.height;
                ctx.fillStyle = "white";
                ctx.strokeStyle = "white";

                cur = data[dataPos];

                /*for(var s of update.Stars) {
                    ctx.beginPath();
                    ctx.arc(getPos(s.Pos.X - center[0], w), getPos(s.Pos.Y - center[1], h), 1000/getScale(), 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(getPos(s.Pos.X - center[0], w), getPos(s.Pos.Y - center[1], h), s.Size / getScale(), 0, 2 * Math.PI);
                    ctx.stroke();
                }*/

                
                var things = { ...base_things};

                ctx.fillStyle = "red";
                ctx.strokeStyle = "red";
                ctx.beginPath();
                ctx.arc(getPos(1600 - center[0], w), getPos(700 - center[1], h), 5*5/getScale(), 0, 2 * Math.PI);
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(getPos(1600 - center[0], w), getPos(700 - center[1], h), Math.min(1, Math.max(0, cur.b1[0]/cur.b1[1])) * 5*5/getScale(), 0, 2 * Math.PI);
                ctx.fill();

                ctx.fillStyle = "blue";
                ctx.strokeStyle = "blue";
                ctx.beginPath();
                ctx.arc(getPos(2600 - center[0], w), getPos(1700 - center[1], h), 5*5/getScale(), 0, 2 * Math.PI);
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(getPos(2600 - center[0], w), getPos(1700 - center[1], h), Math.min(1, Math.max(0, cur.b2[0]/cur.b2[1])) * 5*5/getScale(), 0, 2 * Math.PI);
                ctx.fill();

                ctx.fillStyle = "white";
                ctx.beginPath();
                ctx.arc(getPos(3200 - center[0], w), getPos(1400 - center[1], h), 10*5/getScale(), 0, 2 * Math.PI);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(getPos(1000 - center[0], w), getPos(1000 - center[1], h), 10*5/getScale(), 0, 2 * Math.PI);
                ctx.fill();

                for(var [id, u] of Object.entries(cur.p1)) {
                    ctx.fillStyle = "red";
                    ctx.strokeStyle = "red";

                    things[id] = u[0];

                    ctx.beginPath();
                    ctx.arc(getPos(u[0][0] - center[0], w), getPos(u[0][1] - center[1], h), u[1]*5/getScale(), 0, 2 * Math.PI);
                    ctx.stroke();

                    ctx.beginPath();
                    ctx.arc(getPos(u[0][0] - center[0], w), getPos(u[0][1] - center[1], h), u[2]*0.5/getScale(), 0, 2 * Math.PI);
                    ctx.fill();
                }

                for(var [id, u] of Object.entries(cur.p2)) {
                    ctx.fillStyle = "blue";
                    ctx.strokeStyle = "blue";

                    things[id] = u[0];

                    ctx.beginPath();
                    ctx.arc(getPos(u[0][0] - center[0], w), getPos(u[0][1] - center[1], h), u[1]*5/getScale(), 0, 2 * Math.PI);
                    ctx.stroke();

                    ctx.beginPath();
                    ctx.arc(getPos(u[0][0] - center[0], w), getPos(u[0][1] - center[1], h), u[2]*0.5/getScale(), 0, 2 * Math.PI);
                    ctx.fill();
                }

                if(dataPos > 0) {
                    cur = data[dataPos-1];
                    for(var [id, u] of Object.entries(cur.p1)) {
                        if(!(id in things)) {
                            things[id] = u[0];
                        }
                    }
                    for(var [id, u] of Object.entries(cur.p2)) {
                        if(!(id in things)) {
                            things[id] = u[0];
                        }
                    }
                }

                for(var e of cur.e) {
                    ctx.strokeStyle = "#FFFFFFAA";

                    ctx.beginPath();
                    ctx.moveTo(getPos(things[e[0]][0] - center[0], w), getPos(things[e[0]][1] - center[1], h));
                    ctx.lineTo(getPos(things[e[1]][0] - center[0], w), getPos(things[e[1]][1] - center[1], h));
                    ctx.stroke();
                }

                
            }
        </script>

    </body>
</html>

